#### Abstract

Approximate nearest neighbor (ANN) search is a fundamental search in multi-dimensional databases, which has numerous real-world applications, such as image retrieval, recommendation, entity resolution, and sequence matching. Proximity graph ( PG ) has been the state-of-the-art index for ANN search. However, the search on existing PGs either suffers from a high time complexity or has no performance guarantee on the search result. In this paper, we propose a novel $\tau$-monotonic graph $(\tau-\mathrm{MG})$ to address the limitations. The novelty of $\tau$-MG lies in a $\tau$-monotonic property. Based on this property, we prove that if the distance between a query q and its nearest neighbor is less than a constant $\tau$, the search on $\tau$-MG guarantees to find the exact nearest neighbor of $q$ and the time complexity of the search is smaller than all existing PG-based methods. For index construction efficiency, we propose an approximate variant of $\tau$-MG, namely $\tau$-monotonic neighborhood graph $(\tau$-MNG $)$, which only requires the neighborhood of each node to be $\tau$-monotonic. We further propose an optimization to reduce the number of distance computations in search. Our extensive experiments show that our techniques outperform all existing methods on well-known real-world datasets

## 1 INTRODUCTION

Approximate nearest neighbor (ANN) search in multi-dimensional databases is a fundamental search and has many applications, such as image retrieval [28, 44], recommendation [12], entity resolution [21], and sequence matching [10]. Many ANN search methods have been proposed, such as the tree-based methods [33, 41, 52], quantization-based methods [25, 38, 55], hashing-based methods [34, 49, 60], and proximity graph-based methods [17, 31, 36]. Recent studies [6, 31, 32, 36, 40, 48, 53] show that proxmity graph (PG)-based methods provide superior performance over other methods in many large-scale applications of ANN search.

---

Given a database $D$ with $n$ points in an $m$-dimensional space, the PG-based methods construct a proximity graph $G$ to index $D$, where each node in $G$ corresponds to a point in $D$ and two nodes have an edge if they satisfy some proximity property. For a query point $q$, a greedy routing on $G$ can be used to find the ANN of $q$. Specifically, at each routing step, we compute the distances between $q$ and the neighbors of the current node. Then, we select the neighbor that is the closest to $q$ as the next current node and proceed to the next routing step. The routing stops if no neighbor of the current node is closer to $q$ than itself.

---

Existing PG-based methods mainly lie in either of two following extremes. Let $\bar{v}$ denote the nearest neighbor of $q$ and $\delta(q, \bar{v})$ denote the distance of $\bar{v}$ to $q$. At one extreme, some research studies (e.g., [13, 17, 20]) impose the assumption $\delta(q, \bar{v})=0$ (i.e., $q$ is a point in $D$ ). For example, MRNG [17] guarantees to find $\bar{v}$ by the greedy routing and the expected time complexity is $O\left(n^{2 / m} \ln n\right)$ with probability at least $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$. ${ }^{1}$ However, the assumption $\delta(q, \bar{v})=0$ is not always practical as $q \in D$ may not always hold. At the other extreme, many works (e.g., [16, 29, 32, 36]) study simply the setting $\delta(q, \bar{v})<\infty$. However, these works either cannot provide an error guarantee of the greedy routing (e.g., SSG [16], HNSW [36], DPG [32]) or take $O(n)$ time to retrieve the nearest neighbor $\bar{v}$ (e.g., DG [29]).

- ${ }^1$ The original expected time complexity proved in [17] is $O\left(\frac{1}{\Delta} n^{1 / m} \ln n\right)$, where $\Delta$ is the smallest distance between any two points in $D$. In this paper, we prove that $\Delta \leq O\left((1 / n)^{1 / m}\right)$ with probability at least $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^2}\right)}$.

---

In this paper, we study a practical setting $\delta(q, \bar{v})<\tau$, which falls between the two extremes, where $\tau$ is a user-defined constant. It is motivated by the observation that in real-world benchmark datasets, the queries are usually not in $D$ but close to their nearest neighbors in $D$. For example, in our preliminary experiments on the SIFT dataset with 1 million data points, we observe that $\delta(q, \bar{v})$ is not zero but small when compared with the distances to all points in the dataset. Fig. 1(a) shows the histogram of $\delta(q, \bar{v})$ for 1,000 randomly selected queries. We can see that $20<\delta(q, \bar{v})<270$ for most queries. Fig. 1(b) shows the box plot of the distances between ten randomly selected queries and all the points in SIFT. We can see that $q$ is much closer to its nearest neighbor than the other points in $D$. The only existing work that has considered the setting $\delta(q, \bar{v})<\tau$ is FANNG [20]. FANNG guarantees to find $\bar{v}$ by the greedy routing if $\delta(q, \bar{v})<\tau$. However, we prove that the greedy routing of FANNG has a high time complexity. This paper proposes a solution, which has a lower time complexity, to find the nearest neighbor $\bar{v}$ of $q$ when $q$ satisfies $\delta(q, \bar{v})<\tau$.

---

We analyze the greedy routing and find the key reason for the high time complexity of FANNG is that each routing step gets closer to $q$ by only $\Delta$, where $\Delta$ denotes the smallest distance between any two points in $D$. We show that $\Delta \leq O\left((1 / n)^{1 / m}\right)$ with probability at least $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$. We further prove that the length of the greedy routing on any PG is $O\left(n^{2 / m} \ln n\right)$ with probability at least $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$. This is the first work that can bound the length of the greedy routing in any PG.

---

Based on the analysis, we propose a novel proximity graph, namely $\tau$-monotonic graph ( $\tau$-MG). The core of $\tau$-MG is a new edge occlusion rule: for two nodes $u$ and $v$ in $\tau$-MG, if $u$ has a neighbor in the intersection of the ball centered at $u$ with radius $\delta(u, v)$ and the ball centered at $v$ with radius $\delta(u, v)-3 \tau$, the edge $(u, v)$ is not in the $\tau$-MG. This edge occlusion rule makes $\tau$-MG has a $\tau$-monotonic property: if $\delta(q, \bar{v})<\tau, \tau$-MG has a path from any node to $\bar{v}$, in which each step monotonically gets closer to $q$ by at least $\tau$. This property ensures that $\bar{v}$ can be found by the greedy routing. We further prove that the expected time complexity of the greedy routing is $O\left(n^{1 / m}(\ln n)^{2}\right)$. Fig. 2 shows a comparison of $\tau$-MG with existing methods. To the best of our knowledge, the ANN search method of this paper has the smallest time complexity compared with all existing PG-based ANN search methods.

---

To reduce the time complexity of PG construction, we propose an approximate variant of $\tau$-MG, called $\tau$-monotonic neighborhood graph ( $\tau$-MNG). The main idea is that we only require the subgraph induced by the neighborhood of each node is $\tau$-monotonic. The idea of $\tau$-monotonic neighborhood is generic and $\tau$-MNG can be constructed from any PG. The time complexity of $\tau$-MNG construction is $O\left(n h^{2} \ln h\right)$, where $h$ is the size of the neighborhood and $h$ is much smaller than $n$. Since the greedy routing on $\tau$-MNG may get stuck in local optima, which reduces search accuracy, a beam search is used on $\tau$-MNG for ANN search in order to strike a balance between search accuracy and efficiency. We prove that the probability that the beam search finds $\bar{v}$ is no less than the probability that the search enters the neighborhood of $\bar{v}$.

---

To optimize the beam search on $\tau$-MNG, we propose a query-aware edge occlusion (QEO) method. The main idea is that if the current node $u$ of the search is not in the top $p \%$ of the priority queue of the beam search, we use a lower bound $\delta_{l b}$ of the distance $\delta$ to order the neighbors of $u$ and prune the tail neighbors. It is based on the observation that the farther the current node $u$ away from $q$ is, the higher chance the neighbors of $u$ can be pruned. We also identify two important implementation details for query efficiency.

---

Contributions. The contributions of this paper are as follows.

- We find the key reason for the long routing of existing PGs is that each routing step gets closer to $q$ by only $\Delta$, where $\Delta=O\left((1 / n)^{1 / m}\right)$ with probability at least $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$;
- We propose a novel PG $\tau$-MG, which guarantees to find the nearest neighbor $\bar{v}$ of $q$ by the greedy search if $\delta(q, \bar{v})<\tau$. The time complexity of the greedy search is $O\left(n^{1 / m}(\ln n)^{2}\right)$, which is lower than all existing PG-based methods;
- We propose $\tau$-MNG as an approximate variant of $\tau$-MG. $\tau$-MNG can be efficiently constructed in $O\left(h^{2} \ln h\right)$ time, where $h$ is the neighborhood size, and a beam search on $\tau$-MNG has a high chance of returning $\bar{v}$;
- We propose an optimization to reduce the number of distance computations in the beam search on $\tau$-MNG; and
- Our extensive experiments verify that our proposed techniques outperform the state-of-theart methods on real-world benchmark datasets.

---

Organizations. The rest of this paper is organized as follows. Section 2 discusses the related work. The preliminaries are presented in Section 3. Section 4 presents the analysis of the inefficiency of existing PGs. Section 5 presents $\tau$-MG. $\tau$-MNG is presented in Section 6. The experimental evaluation is presented in Section 7. Section 8 concludes this paper. For presentation clarity, we put the detailed proofs in Section 9.


## 2 RELATED WORK

In this section, we focus on the ANN works that are closely related to proximity graphs (PGs). PGs have been studied recently [ $13,14,16,17,19,20,31,32,35]$. Most existing PGs are based on three fundamental graph models: the Delaunay graph, the navigable small world graph, and the relative neighborhood graph. They are briefly reviewed as follows.

---

Delaunay graph (DG) is the dual graph of the Voronoi diagram [7]. For any query $q$ in the $m$ dimensional Euclidean space $E^{m}$, DG guarantees to find the nearest neighbor of $q$ by a greedy routing [36]. However, when $m$ is large, DG becomes a complete graph [20], which makes the routing time-consuming. To reduce the node degree of DG, $k$-nearest neighbor graph ( kNNG ) is proposed as an approximation of $D G$, where each node is connected to its top- $k$ nearest neighbors. For example, Jin et al. [26] and Hajebi et al. [19] propose IEH and GNNS using kNNG for ANN search, respectively. Since constructing kNNG is time-consuming, which takes $O\left(n^{2}\right)$ time, some research studies propose to construct the approximate kNNG. In particular, Dong et al. [14] propose a PG, namely KGraph to approximate KNNG. KGraph initializes the neighbors of each node randomly and then iteratively improves the neighbors of each node based on the principle that "a neighbor of a neighbor is likely a neighbor". Instead of a random initialization, EFANNA [15] first builds KD-trees on the database and uses ANN search on the KD-trees to initialize the neighbors of each node before executing NN-Descent. However, KGraph and EFANNA cannot ensure the connectivity of the constructed graph, which can significantly degrade the accuracy of the search results [17]. Recently, Wen et al. [32] propose DPG that diversifies the neighboring edges of each node. However, DPG neither reduces the time complexity nor provides an error guarantee for the search results.

---

Navigable small world graph (NSWG) has attracted much research attention since the well-known Milgram's social experiment [39]. Milgram observes that two nodes in a large graph are connected by a short path and the path can be found by a greedy routing. Many works are proposed to explain and analyze the performance of NSWG. For example, Watts and Strogatz [54] propose a 2-dimensional lattice model and prove the existence of a path of the length $O(\ln n)$ between two nodes in the lattice. Kleinberg [27] proves that the greedy routing cannot find the path. Kleinberg [27] proposes another 2-dimensional lattice model that guarantees to find the path of the length $O(\ln n)$ by the greedy routing in $O\left((\ln n)^{2}\right)$ expected time. Martel and Nguyen [37] extend the work of Kleinberg [27] to support $m$-dimensional lattice. Inspired by Kleinberg's model, Malkov et al. [35] propose a PG (namely NSW) to support approximate ANN search in the $m$-dimensional Euclidean space. However, the node degree of NSW is high, which makes the routing costly. NSW does not ensure connectivity, which affects search accuracy. Recently, Malkov et al. [36] propose a hierarchical version of NSW (namely HNSW) to ensure connectivity and support routing in polylogarithmic time. However, the analysis of the time cost lacks rigorous theoretical support. Moreover, HNSW has no error guarantee on the search results.

---

Relative neighborhood graph (RNG) eliminates the longest edge in all possible triangles among the points in the database $D$, i.e., if an edge $(u, v)$ is in the graph, $D$ has no point $u^{\prime}$ satisfying $\delta\left(u, u^{\prime}\right)<\delta(u, v)$ and $\delta\left(u^{\prime}, v\right)<\delta(u, v)$. RNG guarantees the average degree of each node is a small constant [23]. Later, Dearholt et al. [13] prove that RNG does not have sufficient edges to guarantee the accuracy of the search results of the greedy routing. Fu et al. [17] propose the monotonic relative neighborhood graph (MRNG). MRNG ensures that the average degree of each node is a constant and guarantees to find the nearest neighbor of $q$ if $q \in D$. However, if $q \notin D$, MRNG has no error guarantee on the search results. FANNG [20] ensures to find the nearest neighbor $\bar{v}$ of $q$ if $\delta(q, \bar{v})<\tau$. However, FANNG does not provide theoretical analysis on node degree and time complexity of the greedy routing. Recently, Fu et al. [16] extend MRNG to a satellite system graph (SSG). Although SSG is designed for any $q \notin D$, SSG has no error guarantee on the search results of the greedy routing.

---

Several works study improving the routing algorithm on PG. For example, Muñoz et al. [50] propose to prune the neighbors that are not in the same quadrant as $q$ at each routing step. Baranchuk et al. [9] use a graph neural network to select the neighbor to route to. Peng et al. [43] use neural networks to prune unpromissing neighbors to reduce the number of distance computations. Li et al. [31] propose a learning-based method to early stop the routing to avoid unnecessary routing steps. However, these works have no error guarantee on the search results. Zhao et al. [59] and Yu et al. [58] propose using GPUs to accelerate the routing on PG. However, this paper focuses on CPU, which is orthogonal to them.

---

Non-PG-based methods. There are also some ANN works not based on PGs, such as the treebased methods [2, 30, 33, 41, 52], inverted index-based methods [8, 31], the quantization-based methods [ $18,25,38,55]$, and the hashing-based methods [34, 49, 60]. Since recent studies [ $6,31,32$, $36,40,48,53]$ show that these methods are outperformed by PG-based methods, we do not include these methods in this section. We refer interested readers to excellent surveys (e.g., [22, 32, 38, 48]) for more details.

---

There have been studies on the meaningfulness of ANN search [11, 30, 47]. With the increasing of dimensionality, the contrast (i.e., the ratio of the distances between the query $q$ and its nearest and farthest points) tends to 1 and ANN search becomes meaningless, as the NN of $q$ could not be separated from other points. However, if the datasets have a low intrinsic dimensionality or the distance between the query and its nearest neighbor is no more than a constant, contrast exists and ANN search is meaningful [11].