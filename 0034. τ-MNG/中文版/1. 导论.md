#### 摘要

近似最近邻（ANN）搜索是多维数据库中的一项基础搜索技术，广泛应用于图像检索、推荐系统、实体解析和序列匹配等实际场景中。邻近图（Proximity Graph，PG）一直是 ANN 搜索的最先进索引结构。然而，现有 PG 上的搜索要么存在较高的时间复杂度，要么无法对搜索结果提供性能保证。

为了解决这些局限性，本文提出了一种新颖的 **$\tau$-单调图**（$\tau$-monotonic graph, $\tau$-MG）。该图的创新之处在于其 **$\tau$-单调性** 特性。基于该特性，我们证明了：如果查询点 $q$ 与其最近邻的距离小于常数 $\tau$，则在 **$\tau$-MG** 上的搜索不仅可以保证找到 $q$ 的精确最近邻，而且其时间复杂度比所有现有基于 PG 的方法更低。

为了提高索引构建效率，我们提出了 **$\tau$-单调邻域图**（$\tau$-monotonic neighborhood graph, $\tau$-MNG）的近似变体，该变体仅要求每个节点的邻域满足 $\tau$-单调性。此外，我们进一步提出了一种优化策略，以减少搜索过程中的距离计算次数。

我们的大量实验表明，在多个知名的真实数据集上，本文提出的技术在性能上优于所有现有方法

## 1 引言

近似最近邻（ANN）搜索是多维数据库中的一项基础搜索技术，广泛应用于图像检索 [28, 44]、推荐系统 [12]、实体解析 [21] 和序列匹配 [10] 等领域。许多 ANN 搜索方法已被提出，包括基于树的算法 [33, 41, 52]、量化方法 [25, 38, 55]、哈希方法 [34, 49, 60] 和基于邻近图（Proximity Graph, PG）的方法 [17, 31, 36]。

最近的研究 [6, 31, 32, 36, 40, 48, 53] 表明，在 ANN 搜索的许多大规模应用中，基于邻近图（PG）的方法相较于其他方法表现更优。

------

给定一个包含 $n$ 个点的数据库 $D$，这些点位于 $m$ 维空间中，基于 PG 的方法通过构建邻近图 $G$ 来对 $D$ 进行索引。$G$ 中的每个节点对应于 $D$ 中的一个数据点，如果两个节点满足某些邻近性条件，则它们之间存在一条边。

对于查询点 $q$，可以在 $G$ 上执行贪婪路由（greedy routing）来查找 $q$ 的近似最近邻。具体而言，在每一步路由中，计算查询点 $q$ 与当前节点邻居之间的距离，然后选择与 $q$ 最近的邻居作为下一个当前节点，并进入下一步路由。当当前节点的所有邻居都不比当前节点更接近 $q$ 时，路由过程终止。

---

现有的基于 PG 的方法主要分为以下两个极端情况。令 $\bar{v}$ 表示查询点 $q$ 的最近邻，$\delta(q, \bar{v})$ 表示 $\bar{v}$ 与 $q$ 之间的距离。

在第一个极端，一些研究（例如 [13, 17, 20]）假设 $\delta(q, \bar{v})=0$（即 $q$ 是数据库 $D$ 中的一个点）。例如，MRNG [17] 保证可以通过贪婪路由找到 $\bar{v}$，其期望时间复杂度为 $O\left(n^{2 / m} \ln n\right)$，且概率至少为 $1-\left(1 / e\right)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$。然而，假设 $\delta(q, \bar{v})=0$ 在实际应用中并不总是成立，因为 $q \in D$ 并不一定满足。

在第二个极端，许多研究（例如 [16, 29, 32, 36]）仅研究 $\delta(q, \bar{v})<\infty$ 的情况。然而，这些研究要么无法为贪婪路由提供误差保证（例如 SSG [16]、HNSW [36]、DPG [32]），要么需要 $O(n)$ 的时间来检索最近邻 $\bar{v}$（例如 DG [29]）。

- **注释 1：** 在 [17] 中，原始证明的期望时间复杂度为 $O\left(\frac{1}{\Delta} n^{1 / m} \ln n\right)$，其中 $\Delta$ 是 $D$ 中任意两点之间的最小距离。本文证明 $\Delta \leq O\left((1 / n)^{1 / m}\right)$，其概率至少为 $1-\left(1 / e\right)^{\frac{m}{4}\left(1-\frac{3}{e^2}\right)}$。

---

##### 本文研究

本文研究了一种介于上述两种极端情况之间的实际设定，即 $\delta(q, \bar{v})<\tau$，其中 $\tau$ 是用户定义的常数。该设定基于以下观察：在真实的基准数据集中，查询点通常不在 $D$ 中，但它们与 $D$ 中的最近邻距离较近。例如，在我们对包含 100 万个数据点的 SIFT 数据集进行的初步实验中，观察到 $\delta(q, \bar{v})$ 虽然不为零，但相比数据集中所有点的距离较小。

**图 1(a)** 显示了 1,000 个随机查询的 $\delta(q, \bar{v})$ 的直方图。可以看到，大多数查询满足 $20 < \delta(q, \bar{v}) < 270$。

**图 1(b)** 显示了 10 个随机查询与 SIFT 数据集中所有点之间距离的箱线图。结果表明，$q$ 与其最近邻之间的距离远小于其与其他点的距离。

唯一已研究 $\delta(q, \bar{v})<\tau$ 设定的方法是 FANNG [20]。FANNG 保证当 $\delta(q, \bar{v})<\tau$ 时，可以通过贪婪路由找到 $\bar{v}$。然而，我们证明 FANNG 的贪婪路由具有较高的时间复杂度。因此，本文提出了一种解决方案，在 $q$ 满足 $\delta(q, \bar{v})<\tau$ 的条件下，以更低的时间复杂度找到最近邻 $\bar{v}$。

---

我们分析了贪婪路由，并发现 FANNG 时间复杂度较高的关键原因是每一步路由仅以 $\Delta$ 的距离接近 $q$，其中 $\Delta$ 表示 $D$ 中任意两点之间的最小距离。我们证明 $\Delta \leq O\left((1 / n)^{1 / m}\right)$，其概率至少为 $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$。

进一步证明，对于任意 PG，贪婪路由的长度为 $O\left(n^{2 / m} \ln n\right)$，其概率至少为 $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$。这是首次对任意 PG 中贪婪路由的长度进行上界约束的研究。

---

基于上述分析，我们提出了一种新型邻近图，即 **$\tau$-单调图（$\tau$-MG）**。

$\tau$-MG 的核心在于一种新的边遮蔽规则：对于 $\tau$-MG 中的两个节点 $u$ 和 $v$，如果 $u$ 存在一个邻居位于以下两个球体交集内：

1. 以 $u$ 为中心、半径为 $\delta(u, v)$ 的球体；
2. 以 $v$ 为中心、半径为 $\delta(u, v)-3 \tau$ 的球体；

则边 $(u, v)$ 不属于 $\tau$-MG。

这种边遮蔽规则赋予 $\tau$-MG 一种 **$\tau$-单调性** 特性：如果 $\delta(q, \bar{v})<\tau$，则 $\tau$-MG 中存在一条从任意节点到 $\bar{v}$ 的路径，该路径每一步都至少以 $\tau$ 的距离接近 $q$。

这种特性确保了贪婪路由可以找到 $\bar{v}$。我们进一步证明，贪婪路由的期望时间复杂度为 $O\left(n^{1 / m}(\ln n)^{2}\right)$。

**图 2** 显示了 $\tau$-MG 与现有方法的比较结果。据我们所知，本文提出的 ANN 搜索方法相比所有现有基于 PG 的 ANN 搜索方法，具有最小的时间复杂度。

---

为了降低 PG 构建的时间复杂度，我们提出了 **$\tau$-单调邻域图（$\tau$-MNG）**，这是 $\tau$-MG 的一种近似变体。其核心思想是仅要求每个节点邻域所诱导的子图满足 **$\tau$-单调性**。

$\tau$-单调邻域的思想具有通用性，$\tau$-MNG 可以从任何 PG 构建而来。$\tau$-MNG 的构建时间复杂度为 $O\left(n h^{2} \ln h\right)$，其中 $h$ 是邻域大小，且 $h$ 远小于 $n$。

由于 $\tau$-MNG 上的贪婪路由可能陷入局部最优，导致搜索精度下降，因此在 $\tau$-MNG 上使用 **波束搜索（beam search）** 进行 ANN 搜索，以平衡搜索精度和效率。我们证明了波束搜索找到 $\bar{v}$ 的概率不低于搜索进入 $\bar{v}$ 邻域的概率。

---

##### $\tau$-MNG 的波束搜索优化

为了进一步优化 $\tau$-MNG 上的波束搜索，我们提出了一种 **查询感知边遮蔽方法（Query-Aware Edge Occlusion, QEO）**。

其核心思想是：如果搜索过程中的当前节点 $u$ 不在波束搜索优先队列的前 $p%$ 中，则根据距离 $\delta$ 的下界 $\delta_{lb}$ 对 $u$ 的邻居进行排序，并剪除尾部邻居。

这一方法基于以下观察：当前节点 $u$ 离查询点 $q$ 越远，其邻居被剪除的可能性越高。

此外，我们还识别了两个提高查询效率的重要实现细节。

---

##### 贡献

本文的主要贡献如下：

- 我们发现现有 PG 路由过程较长的关键原因是每一步路由仅以 $\Delta$ 的距离接近 $q$，其中 $\Delta=O\left((1 / n)^{1 / m}\right)$，其概率至少为 $1-(1 / e)^{\frac{m}{4}\left(1-\frac{3}{e^{2}}\right)}$；
- 我们提出了一种新型 PG **$\tau$-MG**，该方法保证在 $\delta(q, \bar{v})<\tau$ 时，通过贪婪搜索可以找到 $q$ 的最近邻 $\bar{v}$。贪婪搜索的时间复杂度为 $O\left(n^{1 / m}(\ln n)^{2}\right)$，低于所有现有基于 PG 的方法；
- 我们提出了 $\tau$-MG 的近似变体 **$\tau$-MNG**，其构建时间复杂度为 $O\left(h^{2} \ln h\right)$，其中 $h$ 为邻域大小。在 $\tau$-MNG 上执行波束搜索时，找到 $\bar{v}$ 的概率较高；
- 我们提出了一种优化策略，用于减少在 $\tau$-MNG 上波束搜索时的距离计算次数；
- 我们的大量实验验证了所提出技术在真实基准数据集上优于现有最先进的方法。

---

##### 结构安排

本文其余部分的结构如下：

- **第 2 节** 讨论相关工作；
- **第 3 节** 介绍基本概念；
- **第 4 节** 分析现有 PG 方法的低效性；
- **第 5 节** 提出 $\tau$-MG；
- **第 6 节** 提出 $\tau$-MNG；
- **第 7 节** 展示实验评估结果；
- **第 8 节** 总结本文工作；
- 为便于阅读，详细证明放在 **第 9 节**。

## 2 相关工作

本节重点介绍与邻近图（Proximity Graphs, PGs）密切相关的近似最近邻（ANN）研究。近年来，PG 已成为研究热点 [13,14,16,17,19,20,31,32,35]。

大多数现有的 PG 基于三种基本图模型：**德洛内图（Delaunay Graph）**、**可导航小世界图（Navigable Small World Graph）** 和 **相对邻域图（Relative Neighborhood Graph）**。以下是它们的简要回顾：

---

## 2 相关工作

本节重点介绍与邻近图（Proximity Graphs, PGs）密切相关的近似最近邻（ANN）研究。近年来，PG 已成为研究热点 [13,14,16,17,19,20,31,32,35]。

大多数现有的 PG 基于三种基本图模型：**德洛内图（Delaunay Graph）**、**可导航小世界图（Navigable Small World Graph）** 和 **相对邻域图（Relative Neighborhood Graph）**。以下是它们的简要回顾：

------

**德洛内图 (DG)**

德洛内图是 **Voronoi 图** 的对偶图 [7]。在 $m$ 维欧几里得空间 $E^{m}$ 中，DG 保证可以通过贪婪路由找到查询点 $q$ 的最近邻 [36]。

然而，当 $m$ 较大时，DG 会变成一个完全图 [20]，这使得路由过程耗时较长。

**$k$-最近邻图 (kNNG)**

为了降低 DG 的节点度数，提出了 $k$-最近邻图（kNNG）作为 DG 的近似模型，其中每个节点仅与其前 $k$ 个最近邻节点相连。例如：

- Jin 等人 [26] 和 Hajebi 等人 [19] 分别提出了基于 kNNG 的 IEH 和 GNNS 算法，用于 ANN 搜索。

由于构建 kNNG 的时间复杂度较高，为 $O\left(n^{2}\right)$，一些研究提出了近似构建 kNNG 的方法：

- Dong 等人 [14] 提出了 PG 模型 **KGraph**，用于近似 kNNG。该方法首先随机初始化每个节点的邻居，然后基于“邻居的邻居很可能也是邻居”的原则，迭代优化每个节点的邻居。
- EFANNA [15] 则采用另一种方法，首先在数据库上构建 **KD 树**，并在 KD 树上进行 ANN 搜索，以初始化每个节点的邻居，然后执行 **NN-Descent** 进一步优化。

**存在的问题**

尽管上述方法有所改进，但 KGraph 和 EFANNA 不能保证构建图的连通性，这会显著降低搜索结果的准确性 [17]。

最近，Wen 等人 [32] 提出了 **DPG**，通过多样化每个节点的邻边来优化图结构。然而，DPG 既不能降低时间复杂度，也无法为搜索结果提供误差保证。

---

##### **可导航小世界图 (NSWG)**

自著名的 Milgram 社会实验 [39] 以来，可导航小世界图 (NSWG) 吸引了大量研究关注。Milgram 观察到大型图中的两个节点通过一条较短的路径连接，并且可以通过贪婪路由找到该路径。

许多研究尝试解释和分析 NSWG 的性能。例如：

- Watts 和 Strogatz [54] 提出了一个 **二维网格模型**，并证明在该网格中，两个节点之间存在长度为 $O(\ln n)$ 的路径。
- Kleinberg [27] 证明贪婪路由无法找到该路径，并进一步提出了另一个 **二维网格模型**，该模型可以在 $O\left((\ln n)^{2}\right)$ 的期望时间内通过贪婪路由找到长度为 $O(\ln n)$ 的路径。
- Martel 和 Nguyen [37] 将 Kleinberg [27] 的研究扩展到支持 **$m$ 维网格**。

##### **NSW 的应用与局限**

受到 Kleinberg 模型的启发，Malkov 等人 [35] 提出了一种 PG（即 NSW）用于在 $m$ 维欧几里得空间中支持近似 ANN 搜索。

然而，NSW 存在以下问题：

1. **节点度数较高**——使得路由过程开销较大。
2. **连通性无法保证**——影响搜索的准确性。

##### **HNSW 的改进**

最近，Malkov 等人 [36] 提出了 NSW 的层次化版本 **HNSW**，以确保图的连通性，并支持多对数时间 (polylogarithmic time) 内的路由。

然而：

1. HNSW 的时间复杂度分析缺乏严格的理论支持；
2. HNSW 在搜索结果上没有误差保证。

---

##### **相对邻域图 (RNG)**

相对邻域图 (RNG) 通过消除数据库 $D$ 中所有可能三角形中的最长边进行构建。具体而言，如果边 $(u, v)$ 存在于图中，则 $D$ 中不存在一个点 $u^{\prime}$ 满足以下条件：

1. $\delta\left(u, u^{\prime}\right)<\delta(u, v)$ 且
2. $\delta\left(u^{\prime}, v\right)<\delta(u, v)$。

RNG 保证每个节点的平均度数是一个小常数 [23]。

##### **RNG 的局限性与改进**

- Dearholt 等人 [13] 证明，RNG 不具有足够的边来保证贪婪路由搜索结果的准确性。
- Fu 等人 [17] 提出了 **单调相对邻域图 (MRNG)**。MRNG 确保每个节点的平均度数是一个常数，并保证当 $q \in D$ 时可以找到 $q$ 的最近邻。然而，当 $q \notin D$ 时，MRNG 无法对搜索结果提供误差保证。
- **FANNG** [20] 保证在 $\delta(q, \bar{v})<\tau$ 时可以找到 $q$ 的最近邻 $\bar{v}$，但 FANNG 没有对节点度数和贪婪路由时间复杂度提供理论分析支持。
- 最近，Fu 等人 [16] 将 MRNG 扩展为 **卫星系统图 (SSG)**，该方法适用于 $q \notin D$ 的情况。然而，SSG 同样无法对贪婪路由的搜索结果提供误差保证。

---

##### **改进 PG 路由算法的相关研究**

一些研究致力于改进 PG 上的路由算法。例如：

- Muñoz 等人 [50] 提出在每一步路由中，修剪不与查询点 $q$ 位于同一象限的邻居；
- Baranchuk 等人 [9] 利用图神经网络选择路由方向的邻居；
- Peng 等人 [43] 使用神经网络剪除不具潜力的邻居，以减少距离计算次数；
- Li 等人 [31] 提出一种基于学习的方法，通过提前停止路由避免不必要的路由步骤。

然而，这些研究都无法对搜索结果提供误差保证。

此外，Zhao 等人 [59] 和 Yu 等人 [58] 提出了使用 GPU 加速 PG 上的路由过程。但本文的研究侧重于 CPU，实现方式与它们互为补充。.

---

##### **非 PG 方法**

还有一些非基于 PG 的 ANN 方法，例如：

- **基于树的方法** [2, 30, 33, 41, 52]；
- **基于倒排索引的方法** [8, 31]；
- **基于量化的方法** [18, 25, 38, 55]；
- **基于哈希的方法** [34, 49, 60]。

由于最近的研究 [6, 31, 32, 36, 40, 48, 53] 显示这些方法的性能均不如基于 PG 的方法，因此本文未在本节进一步讨论这些方法。感兴趣的读者可参考相关综述 [22, 32, 38, 48] 以获取更详细的信息。

---

##### **关于 ANN 搜索有效性的研究**

已有一些研究关注 ANN 搜索的有效性 [11, 30, 47]。

随着数据维度的增加，距离对比度（contrast，即查询点 $q$ 与其最近点和最远点之间距离的比值）趋向于 1，此时 ANN 搜索会变得无意义，因为 $q$ 的最近邻无法从其他点中有效区分。

然而，如果数据集具有较低的内在维度，或者查询点与其最近邻的距离不超过某个常数，则对比度仍然存在，ANN 搜索依然具有意义 [11]。