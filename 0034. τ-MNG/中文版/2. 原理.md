## 3 预备知识

在本节中，我们首先介绍问题设定，然后介绍邻近图。

### 3.1 问题设定

在本文中，我们用 $E^{m}$ 表示 $m$ 维欧几里得空间。两点 $u$ 和 $v$ 之间的距离采用 $L_{2}$ 范数 $\delta(u, v)$ 测量。近似最近邻 (ANN) 搜索问题定义如下：

**ANN 搜索问题。** 给定数据库 $D$，其中包含 $E^{m}$ 中的 $n$ 个数据点，以及 $E^{m}$ 中的查询点 $q$，和一个小常数 $\epsilon \geq 0$，我们的目标是高效地找到数据库中某个点 $p$，使得 $\delta(p, q) \leq(1+\epsilon) \delta(\bar{v}, q)$，其中 $\bar{v}$ 是 $D$ 中距离 $q$ 最近的邻居。

------

为了便于建模和评估，通常不会直接使用 $\epsilon$ 的确切值，而是采用其他指标来衡量搜索精度 [16, 17, 31, 36, 43, 53]。ANN 搜索中广泛使用的精度衡量指标包括基于排名的指标 [16, 17, 53] 和基于距离的指标 [32, 42]。ANN 搜索问题可以自然地推广到近似 $k$ 近邻 ($k$-ANN) 搜索问题 [16, 17]。

在本文中，我们用 $\operatorname{ball}(u, r)$ 表示以 $u$ 为中心、半径为 $r$ 的开球。如果球心不关心，则用 $\operatorname{ball}(r)$ 表示。此外，我们用 lune $(u, v)$ 表示两个球 $\operatorname{ball}(u, \delta(u, v))$ 和 $\operatorname{ball}(v, \delta(u, v))$ 的交集。

### 3.2 邻近图

数据库 $D$ 的邻近图 (Proximity Graph, PG) 是一个有向图 $G$，其中 $G$ 的节点是 $D$ 中的点，如果两个节点满足某种邻近性质，则它们之间存在一条边。对于 $G$ 中的一个节点 $u$，我们用 $N_{G}(u)$ 表示 $u$ 在 $G$ 中的出邻居集合，用 $N_{G}^{-}(u)$ 表示 $G$ 中不属于 $N_{G}(u)$ 的节点集合。

PG 中的一条路径 $P=\left[u_{0}, u_{1}, \ldots, u_{|P|-1}\right]$，对于查询点 $q$，如果每一步都更接近 $q$，即对 $i=1, \ldots,|P|-1$ 满足 $\delta\left(u_{i}, q\right)<\delta\left(u_{i-1}, q\right)$，则称该路径为关于查询点 $q$ 的单调路径 (monotonic path)。

------

算法 1 展示了 PG 上的搜索算法，这是一种广泛应用于现有工作中的波束搜索算法 (beam search)，例如 $[16,17,32,35,45,51,53,59]$。贪婪路由 (greedy routing) 是算法 1 的一种特例，当波束大小 $b=1$ 时，它就等价于贪婪路由。

波束大小越大，搜索精度越高，但搜索速度越慢。算法 1 可以轻松扩展为支持 $k$-ANN 搜索，通过设置 $b \geq k$ 并在第 13 行返回 $W$ 中最佳的前 $k$ 个节点即可。

#### 3.2.1 单调相对邻域图

单调相对邻域图 (Monotonic Relative Neighborhood Graph, MRNG) [17] 是一种广为人知的邻近图 (PG)。MRNG 的核心思想是利用较短的边遮蔽较长的边，该规则定义如下：（这种边遮蔽规则也被其他基于 PG 的方法采用，包括 NSSG [16]、HNSW [36] 和 FANNG [20]。）

------

**定义 1.（MRNG 的边遮蔽规则）** 给定图 $G$ 中的三个节点 $u, u^{\prime}$ 和 $v$，如果边 $(u, u^{\prime}) \in G$ 且 $u^{\prime} \in$ lune $(u, v)$，则边 $(u, v) \notin G$。换句话说，我们说边 $(u, u^{\prime})$ 遮蔽 (occludes) 了边 $(u, v)$。

图 3(a) 展示了边 $(u, u^{\prime})$ 遮蔽边 $(u, v)$ 的示例。基于边遮蔽规则，MRNG 定义如下：

------

**定义 2.（MRNG）** 给定数据库 $D$，邻近图 $G$ 是一个 MRNG，当且仅当对于任意满足 $(u, v) \notin G$ 的两个节点 $u, v \in G$，$G$ 中存在一条边 $(u, u^{\prime})$ 遮蔽了边 $(u, v)$。

MRNG 具有以下性能保证：

**引理 1.** 如果查询点 $q \in D$，则 MRNG 上的贪婪搜索可以从任意节点找到 $q$。然而，如果 $q \notin D$，则 MRNG 上的贪婪搜索可能无法找到 $q$ 的最近邻。

图 3(b) 展示了 MRNG 上贪婪搜索无法找到查询点 $q$ 最近邻 (NN) 的示例。边 $(u, v)$ 被边 $(u, u^{\prime})$ 遮蔽。假设贪婪路由的当前节点是 $u$，由于 $\delta(q, u)<\delta\left(q, u^{\prime}\right)$，贪婪路由将停止并返回 $u$，然而 $v$ 才是 $q$ 的最近邻。

需要指出的是，尽管 MRNG 设计用于欧几里得空间 [17]，但 MRNG 仍可应用于一般度量空间。然而，在一般度量空间中，[17] 中关于 MRNG 的时间和空间复杂度分析不再成立。

## 4 现有邻近图低效性的分析

在本节中，我们分析现有邻近图 (PG) 低效的原因。在 PG 上进行近似最近邻 (ANN) 搜索的时间成本主要由两个因素决定：路由长度（即路由步骤数）和节点度数。本节我们关注第一个因素，因为在许多现有 PG 中，节点度数受常数限制 $[16,17,36]$。

- ${ }^{2}$MRNG [17] 和 SSG [16] 证明它们的最大节点度数是常数。HNSW [36] 将节点度数限制在一个预定义的常数内。

------

Fu 等人 [17] 分析了单调搜索网络 (MSNET) 中贪婪路由的期望长度。然而，该分析存在两个局限性。

第一，MSNET 是一种特殊的 PG，它要求对于每个节点 $v$，PG 都存在一条从任意节点到 $v$ 的单调路径。

第二，查询点 $q$ 必须是数据库中的一个点。

与之对比，我们分析的是任意 PG 中贪婪路由的期望长度，并且 $q$ 可以是 $R^{m}$ 中的任意点。我们的结果比 [17] 更具一般性。

------

**定理 1.** 回顾与 [17] 相同的假设如下：

- 给定包含 $n$ 个点的数据库 $D$，$D$ 中的点均匀分布在 $E^{m}$ 的有限子空间中，并且 $m$ 是一个常数。
- 存在常数 $\psi$，使得 $\psi V_{D} \geq \operatorname{Vol}(\operatorname{ball}(R))$，其中 $V_{D}$ 表示包含 $D$ 的最小凸包的体积，$R$ 表示 $D$ 中任意两点之间的最大距离，$\operatorname{ball}(R)$ 表示半径为 $R$ 的球体。

点密度 $g$ 可以随 $n$ 增长而增加，并且我们假设 $g$ 是 $O(\ln n) .{ }^{3}$。此外，我们进一步假设查询点 $q$ 的分布与 $D$ 中的点相同。

---

对于任意数据库 $D$ 的邻近图 (PG) $G$，查询点 $q$ 的贪婪路由的期望长度为 $O\left(\cfrac{1}{\Delta} n^{\cfrac{1}{m}} \ln n^{\cfrac{1}{m}}\right)$, 其中 $\Delta$ 表示 $D$ 中任意两点之间的最小距离，并且满足 $\Delta \leq O\left((1 / n)^{1 / m}\right)$ 的概率至少为$1-\left(\cfrac{1}{e}\right)^{\cfrac{m}{4}\left(1-\cfrac{3}{e^{2}}\right)}$. 因此，贪婪路由的期望长度至少为 $O\left(n^{\cfrac{2}{m}} \ln n\right)$ 的概率至少为 $1-\left(\cfrac{1}{e}\right)^{\cfrac{m}{4}}\left(1-\cfrac{3}{e^{2}}\right)$.

---

**证明思路：** 设贪婪路由找到的路径为 $\left[v_{0}, v_{1}, \ldots, v_{x}\right]$。

1. 首先证明路径的期望长度 $\mathbb{E}[x]=O\left(\cfrac{1}{\Delta} n^{\cfrac{1}{m}} \ln n^{\cfrac{1}{m}}\right)$, which follows the framework of [17]. 
2. 然后证明 $\Delta \leq O\left(\sqrt{m}(m / n)^{1 / m}\right)$ 的概率至少为 $1-\left(\cfrac{1}{e}\right)^{\cfrac{m}{4}\left(1-\cfrac{3}{e^2}\right)}$. 其主要思想是证明任意两点同时位于体积为 $O(\mathrm{~m} / \mathrm{n})$ 的超立方体中的概率至少为 $1-\left(\cfrac{1}{e}\right)^{\cfrac{m}{4}\left(1-\cfrac{3}{e^{2}}\right)}$.

---

**定理 1 的结论：**

从定理 1 可以看出，任意现有 PG 上的路由都较长。其原因在于，每一步路由仅能使查询点 $q$ 更接近目标 $\Delta$ 的距离，而当 $n \rightarrow \infty$ 时 $\Delta \rightarrow 0$。

## 5. $\tau$-单调图 ($\tau$-MG)

为了解决现有邻近图 (PG) 的局限性 (参见第 4 节)，本节提出了 $\tau$-单调图 ($\tau$-MG)。

如果 $\delta(q, \bar{v})<\tau$，则贪婪路由的每一步（除最后一步外）都会以常数 $\tau$ 的距离更接近查询点 $q$。因此，贪婪路由的期望长度被减少到 $O\left(n^{\cfrac{1}{m}} \ln n\right)$. 

此外，如果 $\delta(q, \bar{v})<\tau$，则 $\tau$-MG 上的贪婪路由一定能找到最近邻 $\bar{v}$。$\tau$-MG 的设计基于以下更严格的边遮蔽规则：

---

**定义 3. ($\tau$-MG 的边遮蔽规则)** 给定图 $G$ 中的三个节点 $u, u^{\prime}$ 和 $v$，如果 $(u, u^{\prime}) \in G$ 且 $u^{\prime}$ 位于以下两个球的交集：$\text{ball}(u, \delta(u, v))$和$\text{ball}(v, \delta(u, v)-3 \tau)$

则 $(u, v) \notin G$。

图 3(c) 展示了 $\tau$-MG 的边遮蔽规则。

---

**定义 4. ($\tau-\mathrm{MG}$)** 给定一个常数 $\tau \geq 0$，$\tau$-单调图 ($\tau-\mathrm{MG}$) 是一个有向邻近图 $G=(V, E)$，其中对于任意两个节点 $u$ 和 $v$：

- 如果 $\delta(u, v) \leq 3 \tau$，则 $(u, v) \in G$；
- 如果 $\delta(u, v)>3 \tau$ 且 $(u, v) \notin G$，则 $G$ 中存在边 $(u, u^{\prime})$ 遮蔽边 $(u, v)$。

---

我们提出了一种新的概念——$\tau$-单调路径。$\tau$-单调路径保证每一步（除最后一步外）至少以 $\tau$ 的距离更接近查询点 $q$。

**定义 5. ($\tau$-单调路径)**

对于查询点 $q$，邻近图上的路径

$P=\left[v_{0}, v_{1}, \ldots, v_{x}, v_{x+1}\right]$

是 $\tau$-单调路径，当且仅当满足：

对于 $i=0, \ldots, x-1$：$\delta\left(v_{i+1}, q\right)<\delta\left(v_{i}, q\right)-\tau$且$\delta\left(v_{x+1}, q\right)<\delta\left(v_{x}, q\right)$ 

---

基于 $\tau$-单调路径，我们定义 $\tau$-单调性质如下：

**定义 6. ($\tau$-单调性质)**

给定数据库 $D$ 和常数 $\tau>0$，如果查询点 $q$ 满足$\delta(q, \bar{v})<\tau$

则 $D$ 的邻近图 $G$ 是 $\tau$-单调的，当且仅当 $G$ 从任意节点到 $q$ 的最近邻 $\bar{v}$ 存在 $\tau$-单调路径。

---

基于边遮蔽规则 (定义 3)，可以证明：

如果$\delta(q, \bar{v})<\tau$ 

则 $\tau$-MG 必然存在从任意节点到 $\bar{v}$ 的 $\tau$-单调路径。因此，我们得出以下引理：

**引理 2.** $D$ 的 $\tau$-MG 是 $\tau$-单调的。

### 5.1 Construction of $\tau$-MG

$\tau$-MG 的构建总体思想是首先构建一个 MRNG，然后在 MRNG 的基础上插入边，从而得到 $\tau$-MG。这是因为根据 MRNG 和 $\tau$-MG 的定义，$\tau$-MG 是一个 MRNG，但 MRNG 可能缺少一些满足 $\tau$-MG 定义的边。

从图 3(c) 中的示例可以看出，如果 $u$ 在灰色区域内有一个出邻居 $u^{\prime \prime}$，则边 $(u, u^{\prime \prime})$ 在 MRNG 中可以遮蔽边 $(u, v)$，然而在 $\tau$-MG 中，$(u, u^{\prime \prime})$ 无法遮蔽 $(u, v)$。

---

**算法 2** 展示了 $\tau$-MG 的构建算法。具体而言，第 1 行构建了一个 MRNG。对于 MRNG 中的每个节点 $u$，第 3-4 行将节点列表 $L$（即不是 $u$ 出邻居的节点列表）按与 $u$ 的距离升序排序。

对于列表 $L$ 中的第 $i$ 个节点 $v$，第 6-10 行根据定义 4 检查是否需要将边 $(u, v)$ 插入到 $\tau$-MG 中。

---

**$\tau$-MG 的节点度分析如下引理：**

**引理 3.** 给定包含 $n$ 个点的数据库 $D$ 和常数 $\tau > 0$，在定理 1 的假设下，由算法 2 构建的 $\tau$-MG $G$ 的期望节点度为 $O(\ln n)$，且 $G$ 的期望大小为 $O(n \ln n)$。

**证明思路：**

已有研究 [17] 已经证明 MRNG 的期望节点度是一个常数。因此，我们只需要证明对于 $G_{0}$ 中的每个节点 $u$，第 8 行和第 10 行插入的边数期望值均为 $O(\ln n)$。

---

对于第 8 行，由于 $n$ 个点均匀分布且密度为 $g$，因此第 8 行为节点 $u$ 插入的边数为 $\operatorname{Vol}(\operatorname{ball}(u, 3 \tau)) \times g$。由于 $\tau$ 是一个常数且 $g=O(\ln n)$，因此 $\operatorname{Vol}(\operatorname{ball}(u, 3 \tau)) \times g$ 为 $O(\ln n)$。

对于第 10 行，如果第 10 行插入边 $(u, v)$，则 $u$ 必须在 $G_{0}$ 中有一个邻居 $u^{\prime \prime}$，使得 $u^{\prime \prime}$ 位于 lune$(u, v) \backslash \operatorname{ball}(v, \delta(u, v)-3 \tau)$ 中（参见图 3(c) 的灰色区域）。

插入 $(u, v)$ 的概率为$\operatorname{Pr}(u, v)=\operatorname{Vol}(\operatorname{lune}(u, v) \backslash \operatorname{ball}(v, \delta(u, v)-3 \tau)) / \operatorname{Vol}(\operatorname{lune}(u, v))$ 因为点是均匀分布的，第 10 行插入的边的期望数为 $\displaystyle{}\sum_{v \in N_{G_{0}}^{-}(u)} \operatorname{Pr}(u, v)$. 通过应用算术推导和几何定理，我们可以推导出： $\displaystyle{}\sum_{v \in N_{G_{0}}^{-}(u)} \operatorname{Pr}(u, v)=O(\ln n)$.

---

##### **$\tau$-MG 构建的时间复杂度分析：**

**引理 4.** 给定包含 $n$ 个点的数据库 $D$，$\tau$-MG 构建算法 (算法 2) 的时间复杂度为 $O\left(n^{2} \ln n\right)$.

$\tau$-MG 的构建时间复杂度与 MRNG、FANNG 和 SSG 相同。

### 5.2 基于 $\tau$-MG 的 ANN 搜索

在本小节中，我们提出了一种基于 $\tau$-MG 的新贪婪路由算法。该算法的创新之处在于，每一步路由（除最后一步外）至少可以使查询点 $q$ 更接近 $\tau$ 的距离，从而期望路由长度为 $O\left(n^{\cfrac{1}{m}} \ln n\right)$。

贪婪路由算法的主要思想是：设 $u$ 为当前路由节点。首先，我们尝试路由到 $u$ 的位于 $\operatorname{ball}(u, 3 \tau)$ 之外的邻居。如果所有位于 $\operatorname{ball}(u, 3 \tau)$ 之外的邻居都比 $u$ 更远离 $q$，则路由停止，并扫描 $u$ 在 $\operatorname{ball}(u, 3 \tau)$ 内的邻居以找到搜索结果。算法 3 展示了基于 $\tau$-MG 的详细路由算法。

需要注意的是，该贪婪路由算法是基于 $\tau$-MG 的以下性质设计的：



---

**引理 5.** 给定 $\tau$-MG $G$ 和一个查询点 $q$，假设 $\delta(q, \bar{v})<\tau$，设 $u$ 为 $G$ 中任意节点，如果 $u$ 的所有位于 $\operatorname{ball}(u, 3 \tau)$ 之外的出邻居都比 $u$ 更远离 $q$，则 $\bar{v}$ 在 $\operatorname{ball}(u, 3 \tau)$ 内。

##### **基于 $\tau$-MG 的路由路径长度分析**

**定理 2.** 给定包含 $n$ 个点的数据库 $D$，在定理 1 的相同假设下，对于一个满足 $\delta(q, \bar{v})<\tau$ 的查询点 $q$，其中 $\tau>0$ 是常数，且 $\bar{v}$ 是 $D$ 中 $q$ 的最近邻，算法 3 的期望路由长度为 $O\left(n^{\cfrac{1}{m}} \ln n\right)$，其时间复杂度为 $O\left(n^{\cfrac{1}{m}}(\ln n)^{2}\right)$。

---

**证明思路：**

设算法 3 找到的路径为 $\left[v_{0}, v_{1}, \ldots, v_{x}\right]$。由于 $\delta(q, \bar{v})<\tau$，我们可以证明 

$\mathbb{E}[x] \leq \cfrac{\mathbb{E}\left[\ln \delta\left(q, v_{x}\right)\right]-\ln (R+\tau)}{\ln R-\ln (R+\tau)}$,

其中 $R$ 是 $D$ 中任意两点之间的最大距离。

由于点是均匀分布的，我们可以证明

 $\cfrac{\mathbb{E}\left[\ln \delta\left(q, v_{v}\right)\right]-\ln (R+\tau)}{\ln R-\ln (R+\tau)} \leq O\left(\cfrac{-\ln (r(n)+\tau)}{\ln r(n)-\ln (r(n)+\tau)}\right)$, 其中 $r(n)=\left(\cfrac{n}{C}\right)^{1 / m}$ $C$ 为常数。

 进一步，我们证明 $\cfrac{-\ln (r(n)+\tau)}{\ln r(n)-\ln (r(n)+\tau)}$ 的增长率与 $\cfrac{(r(n)+\tau) \ln (r(n)+\tau)}{\tau}$.具有相同的阶。

因此， $\mathbb{E}[x] \leq O\left(\cfrac{(r(n)+\tau) \ln (r(n)+\tau)}{\tau}\right)$.由于 $\tau$ 是常数，最终得到 $\mathbb{E}[x] \leq O\left(n^{\cfrac{1}{m}}(\ln n)\right)$. 

由于引理 3 已经证明期望节点度为 $O(\ln n)$，因此算法 3 的时间复杂度为 $O\left(n^{\cfrac{1}{m}}(\ln n)^{2}\right)$.

### 5.3 $\tau$-MG 的更新

为了支持更新操作，我们需要定期重建 $\tau$-MG $G$。为优化更新成本，我们在 $O(\ln n)$ 次更新后重建 $G$。具体思路如下：

如果将一个节点 $u$ 插入到 $G$，我们首先计算 $u$ 与 $G$ 中所有节点之间的距离。其次，使用算法 2 的第 3-11 行计算 $u$ 的出邻居。最后，更新 $G$ 中所有节点的出邻居。

具体来说，对于 $G$ 中的每个节点 $v$，如果 $v$ 的所有现有出边都无法遮蔽边 $(v, u)$，则将边 $(v, u)$ 插入到 $G$ 中。插入操作的时间复杂度为 $O(n \ln n)$。

---

如果从 $G$ 中删除一个节点 $u$，我们采用掩蔽策略 (masking strategy) [56] 来保持 $G$ 的连通性。具体做法是，$u$ 不会直接从 $G$ 中删除；$u$ 仍可用于路由，但不会作为查询结果返回。删除操作的时间复杂度为 $O(1)$。

根据定义 4，更新后的图 $G$ 仍然是 $\tau$-MG。因此，如果 $\delta(q, \bar{v})<\tau$，算法 3 可以在更新后的 $G$ 上找到最近邻 $\bar{v}$。

然而，更新后的 $G$ 中某些节点的出邻居数量可能超过 $O(\ln n)$。为了保持 $\tau$-MG 相同的空间复杂度和搜索时间复杂度，我们在 $O(\ln n)$ 次更新后重新构建 $G$。

---

**备注：** 在一般度量空间中，如果查询点 $q$ 与其最近邻 $\bar{v}$ 的距离小于 $\tau$，我们仍然可以使用 $\tau$-MG 找到精确的最近邻 $\bar{v}$。但在此设置下，$\tau$-MG 的时间和空间复杂度是否仍然成立，目前仍是一个未解的问题。

## 6. $\tau$-单调邻域图 ($\tau$-MNG)

由于构建 $\tau$-MG 的时间复杂度为 $O\left(n^{2} \ln n\right)$，本节提出了一种 $\tau$-MG 的近似版本，称为 $\tau$-单调邻域图 ($\tau$-MNG)。$\tau$-MNG 可以高效地构建，并且在 $\tau$-MNG 上的搜索具有较高的概率找到最近邻 $\bar{v}$。

##### **$\tau$-MNG 的核心思想**

$\tau$-MNG 的主要思想是，仅要求 $\tau$-MNG 中每个节点的邻域是 $\tau$-单调的。其中，节点 $u$ 的邻域是由 $u$ 的近邻节点诱导的子图。

该设计思想受到以下观察结果的启发：在邻近图 $G$ 中，大多数路由步骤发生在查询点 $q$ 的最近邻的邻域内 [46,51]。

---

$\tau$-MNG 定义如下：

**定义 7.** 给定数据库 $D$ 和常数 $\tau > 0$，令 $H_{v} \subset D$ 表示点 $v \in D$ 的近似 $h$-近邻，$\tau$-单调邻域图 ($\tau$-MNG) 是一个有向图 $G=(V, E)$，其中对于任意两个节点 $v \in G$ 和 $u \in H_{v}$：

- 如果 $\delta(u, v) \leq 3 \tau$，则 $(u, v) \in G$；
- 如果 $\delta(u, v)>3 \tau$ 且 $(u, v) \notin G$，则 $G$ 中存在边 $\left(u, u^{\prime}\right)$，其中 $u^{\prime} \in H_{v}$，遮蔽边 $(u, v)$。

### 6.1 $\tau$-MNG 的构建

**算法 4** 展示了 $\tau$-MNG 的构建算法。第 1 行构建了一个邻近图 (PG)，例如 NSG [17] 和 HNSW [36]。

然后，对于每个节点 $u$：

第 4-5 行找到 $u$ 的近似 $h$-近邻列表 $H_{u}$。

第 6 行根据 $u$ 与 $H_{u}$ 中节点的距离对这些节点进行排序。

随后，对于 $H_{u}$ 中的每个节点 $v$，如果 $(u, v) \notin G$，则根据定义 4 插入边 $(u, v)$。

---

算法 4 的时间复杂度分析如下：

**引理 6.** 给定包含 $n$ 个点的数据库 $D$、常数 $\tau > 0$，以及常数 $h$ 和 $b$，在定理 1 的假设下，使用算法 4 构建 $\tau$-MNG 的时间复杂度为$O\left(n^{\cfrac{2+m}{m}} \ln n\right)$ 其概率至少为 $1-(1 / e)^{\cfrac{m}{4}\left(1-\cfrac{3}{e^{2}}\right)}$.

**比较分析：**

通过对比引理 6 和引理 4 可以看出，构建 $\tau$-MNG 的时间复杂度远低于构建 $\tau$-MG 的时间复杂度。

### 6.2 基于 $\tau$-MNG 的 ANN 搜索

有人可能会尝试直接在 $\tau$-MNG 上使用算法 3 进行 ANN 搜索。然而，$\tau$-MNG 可能无法从任意节点到最近邻 $\bar{v}$ 建立单调路径。因此，算法 3 在 $\tau$-MNG 上可能会陷入局部最优解，导致搜索精度降低。

为了解决这一问题，我们采用了广泛使用的波束搜索算法 1，以在搜索精度和效率之间取得平衡。

在本小节中，我们首先分析波束搜索在 $\tau$-MNG 上的理论性能，然后提出三项优化措施，以解决实验中发现的波束搜索性能瓶颈。

---

##### **波束搜索精度分析**

波束搜索结果的精度取决于其是否能够进入 $\bar{v}$ 的邻域 $H_{\bar{v}}$。

我们定义波束搜索进入 $H_{\bar{v}}$ 为：在算法 1 的优先队列 $W$ 中添加了 $H_{\bar{v}}$ 中的任意节点。

**引理 7.** 给定数据库 $D$ 的 $\tau$-MNG 图 $G$ 和常数 $\tau > 0$，对于一个满足 $\delta(q, \bar{v})<\tau$ 的查询 $q$，令 $H_{\bar{u}}$ 为 $q$ 的近似 $h$-近邻，$u$ 为 $H_{\bar{v}}$ 中距离 $q$ 最远的节点。如果波束大小大于 $h + h^{\prime}$，其中 $h$ 是邻域大小，$h^{\prime}$ 是 $G$ 中比 $u$ 更接近 $q$ 的节点数，则算法 1 找到 $\bar{v}$ 的概率不小于波束搜索进入 $H_{\bar{u}}$ 的概率。

---

##### **$h^{\prime}$ 的依赖性分析**

$h^{\prime}$ 的值取决于查询点 $q$。虽然目前无法给出 $h^{\prime}$ 的精确表达式，但在实际应用中，可以通过查询工作负载轻松确定相对于搜索精度的最佳 $h^{\prime}$ 值。

例如，在我们的实验中观察到，通过调整 $h^{\prime}$ 的值，可以将召回率调节到 0.95 以上。这一实验结果与已有研究 $[46,51]$ 的结果一致，即波束搜索在实践中很可能进入 $\bar{v}$ 的邻域 $H_{\bar{v}}$。

### 6.2.1 搜索算法的优化

我们提出了一种**查询感知边遮蔽方法** (Query-Aware Edge Occluding, QEO)，用于减少 $\tau$-MNG 上波束搜索中的距离计算数量。

**算法分析：**

算法 1 的第 8 行比较查询点 $q$ 与当前节点 $u$ 的每个邻居 $v$ 之间的距离，以及优先队列 $W$ 中第 $(b-1)$ 个节点的距离。如果 $\delta(q, v)>\delta(q, W[b-1])$，则节点 $v$ 将被剪枝。

在我们的初步实验中观察到：当前节点 $u$ 距离 $q$ 越远，$u$ 的邻居被 $W[b-1]$ 剪枝的概率越高。

**直觉分析：** 假设 $u$ 的邻居在以 $u$ 为中心、半径为 $\max _{v \in N_{G}(u)} \delta(u, v)$ 的球 $\text{ball}_{u}$ 中均匀分布。随着 $q$ 和 $u$ 之间距离的增加，$\text{ball}(q, \delta(q, W[b-1]))$ 与 $\text{ball}_{u}$ 的交集会减少。

图 4 说明了这一直觉：

- $u_{1}$ 靠近 $q$，整个球 $\text{ball}_{u_{1}}$ 都在 $\text{ball}(q, \delta(q, W[b-1]))$ 内，即 $u_{1}$ 的所有邻居都不会被 $W[b-1]$ 剪枝。
- $u_{2}$ 远离 $q$，球 $\text{ball}_{u_{2}}$ 部分位于 $\text{ball}(q, \delta(q, W[b-1]))$ 内，即 $u_{2}$ 的部分邻居可以被 $W[b-1]$ 剪枝。

---

##### **查询感知边遮蔽方法 (QEO)：**

基于上述观察结果，我们提出了一种查询感知边遮蔽方法：

1. 如果当前节点 $u$ 不在 $W$ 的前 $p%$ 中，则对 $u$ 的所有邻居：
   - 计算它们到 $q$ 的距离下界 $\delta_{l b}$。
   - 按 $\delta_{l b}$ 对邻居排序。
   - 仅对前 $p^{\prime}%$ 的邻居计算实际距离 $\delta$ 并将它们加入 $W$；其余 $\left(1-p^{\prime}\right)%$ 的邻居直接剪枝。

2. 如果 $u$ 在 $W$ 的前 $p%$ 中，则对 $u$ 的所有邻居计算 $\delta$ 并将它们加入 $W$。

---

##### **距离下界 $\delta_{l b}$ 的定义：**

节点 $v$ 与查询点 $q$ 之间的距离下界定义为：

 $\delta_{l b}(v, q)=\sqrt{\displaystyle{}\sum_{i=0}^{z}(v[i]-q[i])^{2}}$, 

其中 $v[i]$ 和 $q[i]$ 分别表示 $v$ 和 $q$ 的第 $i$ 个维度，$0<z<m$。

**优化 $\delta_{l b}$ 的紧密度：**

我们对 $v$ 和 $q$ 执行正交变换，使得 $v$ 和 $q$ 的前几个维度占据其欧几里得距离的更大比例：

 $\delta_{l b}(v, q)=\sqrt{\displaystyle{}\sum_{i=0}^{z}((U v)[i]-(U q)[i])^{2}}$, 

其中 $U$ 是一个 $m \times m$ 的正交矩阵，可以通过数据库 $D$ 的奇异值分解 (SVD) 计算得到。

对于任意 $v \in D$，$U v$ 可以离线计算，从而加速查询过程。

### 6.2.2 实现细节

我们讨论两个提高搜索效率的重要实现细节。

**基于部分距离的剪枝 (PDP)。**

在波束搜索过程中，对于当前节点 $u$ 的某个邻居 $v$，只要能够判断 $\delta(q, v)>\delta(q, W[b-1])$，就可以直接剪枝 $v$，而无需精确计算 $\delta(q, v)$。

这种观察启发了**基于部分距离的剪枝方法**。具体而言，在计算和

$\sum_{i=0}^{m}(v[i]-q[i])^{2}$

的 $m$ 次迭代过程中，如果在第 $j$ 次迭代时发现

$\sum_{i=0}^{j}(v[i]-q[i])^{2} > (\delta(q, W[b-1]))^{2}$，

则可以直接剪枝 $v$，无需继续计算剩余部分。这可以节省大量计算成本。

---

**前缀内积索引 (PII)。**

距离计算 $\delta(q, v)$ 可以重新表示为： $\langle q, q\rangle+$ $\langle v, v\rangle-2 \times \displaystyle{}\sum_{i=0}^{m}(v[i] \times q[i])$, 

其中 $\langle\cdot, \cdot\rangle$ 表示内积。

由于 $\langle v, v\rangle$ 可以离线计算，我们只需要在线计算 $\langle q, q\rangle$ 和 $v[i] \times q[i]$。

计算 $v[i] \times q[i]$ 的操作量仅为计算 $(v[i]-q[i])^{2}$ 的一半。此外，$\langle q, q\rangle$ 的计算成本可以在搜索中所有距离计算之间共享，因此总计算成本约可节省一半。

**结合基于部分距离的剪枝 (PDP)：**

为了与 PDP 方法集成，我们将向量 $v$ 划分为多个段，并为这些段的前缀内积建立索引。例如，给定一个段大小参数 $s$，我们为前缀段建立内积索引：

$\langle v[0, i \times s], v[0, i \times s]\rangle, 0<i<\lceil m / s\rceil$. 

然后按段进行基于部分距离的剪枝操作，从而进一步提高效率。

### 6.3 $\tau$-MNG 的更新

与第 5.3 节类似，我们提出在 $O(\ln n)$ 次更新后定期重建 $\tau$-MNG 图 $G$。

**插入操作：**

我们直接采用 HNSW 的策略。具体而言：

1. 在 $G$ 上使用波束搜索找到待插入节点 $u$ 的 $h$-ANN 集合 $H_{u}$。
2. 使用边遮蔽规则 (定义 3) 找出 $u$ 与 $H_{u}$ 中节点之间的边。

**删除操作：**

删除节点的方法与第 5.3 节相同，采用掩蔽策略 (masking strategy)：节点仍可用于路由，但不会作为查询结果返回。

