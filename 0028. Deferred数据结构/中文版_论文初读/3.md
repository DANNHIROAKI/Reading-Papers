# 3. A randomized algorithm.

在上一节中，我们看到了一个确定性算法，使用延迟数据结构在$O((n+r) \text{⸱} \log \min {n, r})$时间内回答$r$个查询。定理3的上界超过了信息论下界一个常数因子3，这是因为我们使用了[12]中给出的中位数算法。找到$n$个元素的中位数需要$3n$次比较，这导致了上界和下界之间的差距。通过仔细实现，我们可以将常数因子减少到2.5，方法是将中位数算法中生成的部分顺序从父节点传递给子节点。 [3]中给出的更容易实现的算法会导致更高的常数因子。有一个Floyd [7]提出的算法，可以在$3n/2$的期望时间内计算中位数。使用它会将常数因子减少到$3/2$。在这里，我们介绍一个随机算法，其中比较次数将是最优的（以高概率）。

---

随机算法与$\S 2$中的算法仅有一个不同之处。在之前的算法中，我们使用节点存储的值的中位数来进行节点扩展的划分。这里，我们将使用一个“平庸元素”来达到同样的目的。平庸元素将被选择得非常接近中位数。更精确地说，平庸元素的秩将位于$t / 2 \pm t^{2 / 3}$的范围内。我们将使用随机化技术来高效地计算平庸元素。首先，从$t$个元素中随机选择一个大小为$O\left(t^{5 / 6}\right)$的子集。这个随机子集的中位数是一个不错的平庸元素候选。选择随机样本并测试其中位元素是否“平庸”需要$t+O\left(t^{5 / 6}\right)$次比较（见下文第5步）。这个采样过程会重复进行，直到找到一个平庸元素。在算法中，$\S 2$中调用的`MEDIAN_FIND`过程应该替换为下面概述的`MEDIOCRE_FIND`过程。

---

过程 MEDIOCRE_FIND（T：值集合）：值；

- 第1步：令$t = |T|$。
- 第2步：从$T$中随机选择一个大小为$2 \text{⸱} \left\lceil t^{5 / 6} \right\rceil + 1$的样本$S$。
- 第3步：令$m \leftarrow$ MEDIAN_FIND $(S)$。
- 第4步：通过与$T - S$中的每个元素比较来计算$m$的秩。
- 第5步：如果$m$的秩不在$(t / 2) \pm t^{2 / 3}$范围内，则返回第2步。
- 第6步：返回$m$。

------

注意，在第4步中，我们不需要将$m$与$S$中的元素进行比较，因为我们假设过程MEDIAN_FIND隐式地为我们提供了相对于$m$的$S$的划分。在最后几层，我们将恢复使用确定性中位数查找，因为节点大小将过小，不适合使用随机化。一个好的选择是，对于前$\log n - 5$层使用过程MEDIOCRE_FIND，对于之后的层使用过程MEDIAN_FIND。这个随机化算法得出以下定理。

---

**定理 4.** 设$T(n, r)$为在$n$个元素上回答$r$个查询时，随机化算法所进行的比较次数。则以下结论成立，且其概率大于$1 - \cfrac{\log r}{\beta \text{⸱} n}$：

$\displaystyle{}T(n, r) \leqq \begin{cases}(1+\alpha)(n \log r+r \log n), & r \leqq n, \\ (1+\alpha)(n+r) \log n, & r>n,\end{cases}$

其中$\beta$依赖于常数$\alpha$的值。

本节的其余部分将证明这个定理，证明将分为五个引理

---

使用“次优元素”（而不是中位数）可能导致不均匀的划分，从而在创建的二叉搜索树中造成不平衡。然而，以下引理表明，新创建的二叉搜索树的高度不会比$\log n$差太多。我们还将证明，搜索树中每个节点在第$i$层所关联的元素数量接近$n / 2^i$。设搜索树中一个节点的大小为与该节点关联的元素数量。

---

**引理 1.** 设$s_i$为第$i$层某个节点的大小，则有：

$\displaystyle{}n_i\left(1-\cfrac{20}{n_i^{1 / 3}}\right) \leqq s_i \leqq n_i\left(1+\cfrac{20}{n_i^{1 / 3}}\right),$

其中$n_i = \cfrac{n}{2^i}$，并且假设$n_i \geq 22$。

**证明：** 我们将通过对层数进行归纳来证明不等式的一侧。显然，在根节点（即$i=0$）时，不等式是成立的，因为$s_0 = n$。假设不等式对于第$i-1$层成立，即

$s_{i-1} \leqq n_{i-1} \text{⸱}\left(1+20 / n_{i-1}^{1 / 3}\right)$

现在我们将$s_{i-1}$个元素根据次优元素进行划分。设$s_i$为两个划分集中的较大者。根据次优元素的定义，我们有

$s_i \leqq s_{i-1} / 2+s_{i-1}^{2 / 3}$. 

利用$(1+x)^a \leq 1 + a \text{⸱} x$，其中$0 \leq a \leq 1$，我们得到：

$\displaystyle{}s_i \leqq n_i\left(1+\cfrac{1}{n_i^{1 / 3}}\left(11 \text{⸱} 2^{2 / 3}+\cfrac{40}{3} \text{⸱} \cfrac{2^{1 / 3}}{n_i^{1 / 3}}\right)\right) .$


对于$n_i \geqq 22$，我们注意到：

$\displaystyle{}\left(11 \text{⸱} 2^{2 / 3}+\cfrac{40}{3} \text{⸱} \cfrac{2^{1 / 3}}{n_i^{1 / 3}}\right) \leqq 20 .$


这意味着我们得到所需的结果：

$\displaystyle{}s_i \leqq n_i\left(1+\cfrac{20}{n_i^{1 / 3}}\right)$

前提是$n_i \geq 22$。

---

**引理 2.** 随机算法中二叉搜索树的高度将是 $\log n + O(1)$。

**证明：** 在第 $k = \log n - 5$ 层时，我们将不再使用次优元素来扩展节点。相反，我们使用存储在节点中的元素的中位数来划分这些元素。此时，引理 1 仍然适用，因为 $n_k = 32 \geq 22$，并且我们有：

$\displaystyle{}s_k \leqq n_k\left(1+\cfrac{20}{n_k^{1 / 3}}\right) \leqq 2^8$

因此，总层数最多为 $k + 8$。树的高度被限制在 $\log n + 3$ 之内。

根据引理 2，可以得出结论：在随机二叉搜索树中的搜索成本将接近最优。现在我们来考虑构建树的成本，特别是节点扩展的总成本。以下结果表明，随机样本的中位数是整个集合的次优元素，并且具有非常高的概率。

---

**引理 3.** 设 $p(t)$ 为在随机采样的单次迭代中，对于大小为 $t$ 的集合，未能得到次优元素的概率。那么，

$\displaystyle{}p(t) \leqq 2 \text{⸱} t^{1 / 2} \text{⸱} \exp \left(-4 \text{⸱} t^{1 / 6}\right) \leqq \cfrac{1}{4 t} .$

**证明：** 设 $T$ 为一个大小为 $t$ 的集合，经过一次随机采样过程后，首先从 $T$ 中选择一个大小为 $s(t) = 2 \text{⸱} f(t) + 1$ 的随机子集，其中 $f(t) = \lceil t^{5 / 6} \rceil$。然后测试该子集 $S$ 的中位数是否为 $T$ 的次优元素。换句话说，$S$ 的中位数在 $T$ 中的排名应该落在区间 $t / 2 \pm t^{2 / 3}$ 内。设 $P(x_r)$ 为元素 $x_r$（$T$ 中第 $r$ 位元素）是 $S$ 的中位数的事件：

$\displaystyle{}P\left(x_r\right)=\binom{r-1}{f(t)} \text{⸱}\left(\cfrac{t-r}{f(t)}\right) /\binom{t}{s(t)}, \quad f(t)<r \leqq t-f(t) .$


设 $d(t) = t^{2 / 3}$。为了简化后续描述，我们将 $f(t)$ 和 $d(t)$ 分别记作 $f$ 和 $d$。显然，

$\displaystyle{}p(t)=\sum_{r=f+1}^{t / 2-d} P\left(x_r\right)+\sum_{r=t / 2+d}^{t-f} P\left(x_r\right)=\cfrac{2 s}{t-2 f} \sum_{r=f+1}^{t / 2-d}\left(\cfrac{r-f}{r}\right) \text{⸱}\binom{r}{f} \text{⸱}\binom{t-r}{f} /\binom{t}{2 \text{⸱} f} .$


我们利用斯特林公式：

$\displaystyle{}n!=(2 \pi n)^{1 / 2}\left(\cfrac{n}{e}\right)^n e^{k_n}, \quad \cfrac{1}{12 n+1}<k_n<\cfrac{1}{12 n}$

经过大量简化，得到以下不等式：

$\displaystyle{}p(t)<2 \text{⸱} f^{1 / 2} \text{⸱} \exp \left(\cfrac{-4 f d^2}{t^2}\right)$


根据 $f(t)$ 和 $d(t)$ 的选择，$p(t)$ 的界限立即得到。下面的不等式也容易验证：

$\displaystyle{}p(t)<2 \text{⸱} t^{1 / 2} \text{⸱} \exp \left(-4 t^{1 / 6}\right)<\cfrac{1}{4 t} .$

---

现在考虑随机算法中扩展节点的整体成本。首先，是找到小随机样本的中位数的成本。引理 5 将表明，即使将所有树的中位数查找成本累加起来，找到小随机样本的中位数的成本也是很小的。更重要的是，判断样本的中位数是否为整个集合的次优元素的成本。由于“次优性”测试隐式地确定了精确的分割（参见 MEDIOCRE_FIND 程序的第 5 步），因此实际的分割操作没有额外的成本。考虑正在构建的树中的第 $i$ 层。设 $m = 2^i$ 为该层的最大节点数。与这一层节点相关的集合的大小必须在区间 $\left(n_i / 2\right) \pm 20 \text{⸱} n^{2 / 3}$ 之间，其中 $n_i = n / m$ 为这些集合的平均大小。假设每次随机采样都能得到一个次优元素。这意味着，测试次优性的总成本为 $n$。然而，会有一些不好的情况，我们没有生成次优元素。设在第 $i$ 层中这样的实例的数量为 $s$。下一个引理表明，具有高概率地，$s$ 被限制在 $\varepsilon m$ 以内，其中 $\varepsilon$ 是一个适当小的常数。设 $c_i$ 为第 $i$ 层测试次优性的成本。当 $s \leq \varepsilon \text{⸱} m$ 时，我们有

$\displaystyle{}c_i \leqq n+n \text{⸱} \varepsilon\left(1+\cfrac{20}{n_i^{1 / 3}}\right)=(1+\alpha) \text{⸱} n$ 

由于在所有层次上都有 $n_i > 1$，因此显然 $\alpha \leq 21 \text{⸱} \varepsilon$。

---

引理 4. 设 $C$ 表示除最后 $O(1 / \varepsilon)$ 层之外所有层次的 $c_i$ 之和，则有

$P(C \geqq(1+\alpha) \text{⸱} n \text{⸱} \log r) \leqq \log r / k^2 \text{⸱} n$.

证明：设随机变量 $\zeta_i$ 表示第 $i$ 层中 $l = (1 + \varepsilon) \text{⸱} m$ 次随机采样中坏实例的数量。我们已经对 $p(t)$ 有了界限，其中 $p(t)$ 是单次随机采样在大小为 $t$ 的节点上的坏实例概率。在第 $i$ 层的 $l$ 次采样中，节点的大小不相等。因此，设 $p$ 表示该层节点上 $p(t)$ 的最大值。设 $E(\zeta)$ 和 $D(\zeta)$ 分别表示随机变量 $\zeta$ 的均值和标准差。切比雪夫不等式表示：

$P(|\zeta-E(\zeta)| \geqq$ $\lambda \text{⸱} D(\zeta)) \leqq 1 / \lambda^2$. 

由于 $E(\zeta_i) = l \text{⸱} p$ 且 $D(\zeta_i) = \sqrt{l \text{⸱} p \text{⸱} (1 - p)}$，我们得到：

$\displaystyle{}P\left(\zeta_i \geqq l-m\right) \leqq \cfrac{1 \text{⸱} p \text{⸱}(1-p)}{m \text{⸱} \varepsilon^2} \quad \text { when } p \leqq \cfrac{\varepsilon}{2 \text{⸱}(1+\varepsilon)}$ 

利用 $p(t)$ 的界限以及第 $i$ 层节点大小的下界，我们得到 $P(s > \varepsilon m) = P(c_i \geq (1 + \alpha) \text{⸱} n) \leq \cfrac{k}{\varepsilon^2} \text{⸱} n$，对于除最后 $O(\log 1 / \varepsilon)$ 层之外的所有层，$k$ 是一个小常数。选择 $\beta = \cfrac{\varepsilon^2}{k}$ 并将概率求和到前 $\log r$ 层，得到所需的界限。

---

理 5. 当 $r < n$ 时，随机样本中寻找中位数的总成本为 $O\left(n^{5 / 6} \text{⸱} r^{1 / 6}\right)$，概率为 $1 - \cfrac{\log r}{\beta \text{⸱} n}$。

证明：在大小为 $t$ 的节点上寻找中位数的成本为 $3t$。设该节点的两个子节点大小分别为 $k \text{⸱} t$ 和 $(1 - k) \text{⸱} t$，其中 $k$ 在 $\cfrac{1}{2}$ 和 1 之间。寻找子节点中位数的成本与 $C(k) \text{⸱} t^{5 / 6}$ 成正比，其中 $C(k) = \left(k^{5 / 6} + (1 - k)^{5 / 6}\right)$。显然，$C(k)$ 在 $k = \cfrac{1}{2}$ 时达到最大值。定义 $C = C\left(\cfrac{1}{2}\right) = 2^{1 / 6}$。因此，从第 $i$ 层到第 $i+1$ 层，寻找中位数的成本最多增加一个因子 $C$。我们知道在第一级的中位数寻找成本为 $3 \text{⸱} n^{5 / 6}$。因此，前 $\log r$ 层的中位数寻找总成本为

$3 \text{⸱} n^{5 / 6} \text{⸱}\left(1+C+C^2 \cdots C^{\log r-1}\right)$

这个和为 $O\left(n^{5 / 6} \text{⸱} r^{1 / 6}\right)$，因为 $C \leq 2^{1 / 6}$。当 $r > n$ 时，中位数寻找的成本界限变为 $O(n)$。在我们目前的分析中，我们忽略了在给定节点上寻找中位数时的重复操作。这是必要的，因为并非每个随机样本的中位数都会是整个集合的“平庸元素”。然而， 引理 4 中的分析同样适用于中位数寻找成本，因为它仅仅是界定了在某一层中“平庸元素”寻找过程的重复次数。

定理 4 直接从引理 2、4 和 5 中得出。